server {
   listen 8975;
   add_header Access-Control-Allow-Origin '*';

   # apn secure none
   location ~ ^/(https?:/)([^/]+)/(.*)$
   {
      set $var_sheme $1;
      set $var_host $2;
	  set $var_uri $3;
	  
      resolver 1.1.1.1 8.8.8.8 ipv6=off;

      proxy_pass $var_sheme/$var_host/$var_uri$is_args$args;
      proxy_http_version 1.1;
      proxy_hide_header 'Access-Control-Allow-Origin';
      #proxy_set_header Referer $var_sheme/$var_host/$3;

      proxy_connect_timeout   20;
      proxy_send_timeout      20;
      proxy_read_timeout      20;

      #proxy_buffering         off;
      proxy_buffer_size       128k;
      proxy_buffers           14 256k;
      proxy_busy_buffers_size     3m; # ограничивает суммарный размер буферов, которые могут быть заняты для отправки ответа клиенту, пока ответ ещё не прочитан целиком.
      proxy_max_temp_file_size    3m;
      proxy_temp_file_write_size  1m;

      proxy_redirect ~^(https?://.+)$ http://$host:8975/$1;
      proxy_redirect ~^/(.+)$ http://$host:8975/$var_sheme/$var_host/$1;

      # nginx-extras / hls proxy
      #proxy_set_header Accept-Encoding "";
      #subs_filter_types mime-type application/vnd.apple.mpegurl application/x-mpegurl;
      #subs_filter (^|\\")http:// $1http://$host:8975/ r;
      #subs_filter (^|\\")https:// $1http://$host:8975/ r;
      #subs_filter ^/ $var_sheme/$host:8975/$var_host/ r;
      #sub_filter_once off;
   }
   
   
   # apn secure nginx
   location ~ ^/([^:]+):([^/]+)/(https?:/)([^/]+)/(.*)$
   {
      set $var_md5 $1;
      set $var_expires $2;

      secure_link $var_md5,$var_expires;
      secure_link_md5 "$secure_link_expires$remote_addr my_secret_key";

      if ($secure_link = "") {
         return 403;
      }

      if ($secure_link = "0") {
         return 410;
      }
   
      set $var_sheme $3;
      set $var_host $4;
	  set $var_uri $5;
	  
      resolver 1.1.1.1 8.8.8.8 ipv6=off;

      proxy_pass $var_sheme/$var_host/$var_uri$is_args$args;
      proxy_http_version 1.1;
      proxy_hide_header 'Access-Control-Allow-Origin';
      #proxy_set_header Referer $var_sheme/$var_host/$5;

      proxy_connect_timeout   20;
      proxy_send_timeout      20;
      proxy_read_timeout      20;

      #proxy_buffering         off;
      proxy_buffer_size       128k;
      proxy_buffers           14 256k;
      proxy_busy_buffers_size     3m; # ограничивает суммарный размер буферов, которые могут быть заняты для отправки ответа клиенту, пока ответ ещё не прочитан целиком.
      proxy_max_temp_file_size    3m;
      proxy_temp_file_write_size  1m;

      proxy_redirect ~^(https?://.+)$ http://$host:8975/$var_md5:$var_expires/$1;
      proxy_redirect ~^/(.+)$ http://$host:8975/$var_sheme/$var_host/$1;

      # nginx-extras / hls proxy
      #proxy_set_header Accept-Encoding "";
      #subs_filter_types mime-type application/vnd.apple.mpegurl application/x-mpegurl;
      #subs_filter (^|\\")http:// $1http://$host:8975/$var_md5:$var_expires/ r;
      #subs_filter (^|\\")https:// $1http://$host:8975/$var_md5:$var_expires/ r;
      #subs_filter ^/ $var_sheme/$host:8975/$var_md5:$var_expires/$var_host/ r;
      #sub_filter_once off;
   }
}

